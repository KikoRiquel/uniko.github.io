---
import ProjectCard from "./ProjectCard.astro";
import ProjectGallery from "./ProjectGallery.astro";
import { PROJECTS } from "@/data/projects";

interface Props {
    owner: "UNIKO" | "Pascale" | "Emile";
}
const { owner } = Astro.props;

const filteredProjects = PROJECTS.filter((p) => p.owner === owner);

const allImages = import.meta.glob<{ default: ImageMetadata }>(
    `/src/assets/projects/**/*.{png,webp,jpg}`,
    { eager: true },
);

// Función para encontrar la portada (imagen que empieza por 1-)
const getCover = (id: string) => {
    const path = Object.keys(allImages).find((key) =>
        key.includes(`${id}/01-`),
    );
    return allImages[path!]?.default;
};
---

<section class="projects-container">
    <div id="project-cursor" class="cursor-pill">open project!</div>

    <div class="grid">
        {
            filteredProjects.map((p) => (
                <ProjectCard
                    id={p.id}
                    title={p.title}
                    coverImage={getCover(p.id)}
                />
            ))
        }
    </div>

    <ProjectGallery />
</section>

<script>
    import gsap from "gsap";

    // Inicializar elementos
    const previews = document.querySelectorAll(".project-preview");

    // Glob para carga dinámica (lazy) de las galerías
    const galleryAssets = import.meta.glob(
        "/src/assets/projects/**/*.{jpg,png,webp}",
        { as: "url" },
    );

    previews.forEach((preview) => {
        preview.addEventListener("click", async () => {
            const id = preview.getAttribute("data-project-id");
            if (!id) return;

            const imagesPath = Object.keys(galleryAssets)
                .filter((p) => p.includes(`/${id}/`))
                .sort();

            const promises = imagesPath.map((path) => galleryAssets[path]());
            // @ts-ignore
            const urls = await Promise.all(promises);

            // @ts-ignore
            if (window.openProjectGallery) {
                // @ts-ignore
                window.openProjectGallery(urls);
            }
        });
    });

    import { mouseFollower } from "@/lib/mouseFollower";
    mouseFollower("#project-cursor", ".projects-container");

    // --- LÓGICA DE CURSOR (GSAP) ---
    // const pill = document.querySelector("#project-cursor");
    // const container = document.querySelector(".projects-container");

    // const xTo = gsap.quickTo(pill, "x", { duration: 0.6, ease: "power3" });
    // const yTo = gsap.quickTo(pill, "y", { duration: 0.6, ease: "power3" });

    // container.addEventListener("mousemove", (e) => {
    //     const rect = container.getBoundingClientRect();
    //     const x = e.clientX - rect.left + 50;
    //     const y = e.clientY - rect.top - 50;

    //     xTo(x);
    //     yTo(y);
    // });

    // container.addEventListener("mouseleave", () => {
    //     gsap.to(pill, { opacity: 0 });
    // });

    // container.addEventListener("mouseenter", () => {
    //     gsap.to(pill, { opacity: 1 });
    // });
</script>

<style>
    .projects-container {
        position: relative;
        cursor: url("/src/assets/cursors/projects-cursor.svg"), default;
        overflow: hidden;
    }
    .grid {
        display: flex;
        flex-direction: column;
    }
    .cursor-pill {
        position: absolute;
        top: 0;
        left: 0;
        pointer-events: none;
        background: var(--color-red);
        color: var(--color-white);
        padding: 0.5rem 1.5rem;
        border-radius: 100vw;
        z-index: 100;
        opacity: 0;
    }
</style>
